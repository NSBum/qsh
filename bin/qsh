#!/bin/bash

QSH_BASE=~/.qsh
QSH_CLIENTS=$QSH_BASE/clients
QSH_CONNECTIONS=$QSH_BASE/.connections

function qsh_invoke_with_password {
  read -r -d '' QSH_INVOKE_PASSWORD <<EOF
    set send_slow {1 .1}
    proc send {ignore arg} {
      sleep .1
      exp_send -s -- \$arg
    }

    set timeout -1
    log_user 0
    spawn $QSH_INVOCATION 
    match_max 100000
    expect -exact "$PASSWORD_PROMPT"
    send -- "$PASSWORD\r"

    interact {
      -o eof {exit}
    }
EOF

  expect -c "$QSH_INVOKE_PASSWORD";
}

function qsh_invoke {
  read -r -d '' QSH_INVOKE <<EOF
    set send_slow {1 .1}
    proc send {ignore arg} {
      sleep .1
      exp_send -s -- \$arg
    }

    set timeout -1
    log_user 0
    spawn $QSH_INVOCATION 
    match_max 100000

    interact {
      -o eof {exit}
    }
EOF

  expect -c "$QSH_INVOKE";
}

CONNECTION=$1
shift 1;
if [[ -z "$CONNECTION" ]]; then
  echo "usage: qsh <connection> | <invocation>";
  echo;
  tree --prune --noreport "$QSH_CONNECTIONS";
  exit 0;
fi;

if [[ "$CONNECTION" != *.json ]]; then
  CONNECTION="${CONNECTION}.json";
fi;

CONNECTION_FILE=$QSH_CONNECTIONS/$CONNECTION
if [[ ! -f "$CONNECTION_FILE" ]]; then
  # Try to perform a direct invocation
  CLIENT=$CONNECTION
  INVOCATION="$*"
  PASSWORD=null
  PROMPT=true

  CLIENT_NAME=$(basename "$CLIENT");
  if [[ ! -d "$QSH_CLIENTS/$CLIENT_NAME" ]]; then
    echo "invalid connection/invocation";
    exit -1;
  fi;

  source "$QSH_CLIENTS/$CLIENT_NAME/qsh-connect";

  # Invoke the client
  qsh_invoke;
  exit 0;
fi;

CONNECTION_DATA=$(cat "$CONNECTION_FILE");

CLIENT="$(echo "$CONNECTION_DATA" | jq -r '.client')";
INVOCATION="$(echo "$CONNECTION_DATA" | jq -r '.invocation')";
PROMPT="$(echo "$CONNECTION_DATA" | jq -r '.prompt')";
PASSWORD="$(echo "$CONNECTION_DATA" | jq -r '.password')";
PROMPT="$(echo "$CONNECTION_DATA" | jq -r '.prompt')";
VANILLA="$(echo "$CONNECTION_DATA" | jq -r '.vanilla')";

if [ "$CLIENT" == "null" ] || [ "$INVOCATION" == "null" ]; then
  echo "invalid connection definition";
  exit -1;
fi;

CLIENT_NAME=$(basename "$CLIENT");
INVOCATION="$INVOCATION $*";

source "$QSH_BASE/clients/$CLIENT_NAME/qsh-connect";

if [[ "$PASSWORD" == "null" ]]; then
  qsh_invoke;
  exit 0;
fi;

qsh_invoke_with_password;

