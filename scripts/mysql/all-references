#!/bin/bash

FILTER=$2

cat <<EOF > $1
select * from (
  select cr.TABLE_SCHEMA as REFERENCING_TABLE_SCHEMA, cr.TABLE_NAME as REFERENCING_TABLE_NAME,
         cr.CONSTRAINT_NAME as REFERENCING_CONSTRAINT_NAME,
         cu.TABLE_SCHEMA as REFERENCED_TABLE_SCHEMA, cu.TABLE_NAME as REFERENCED_TABLE_NAME,
         cu.CONSTRAINT_NAME as REFERENCED_CONSTRAINT_NAME
  from INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS rc
  inner join INFORMATION_SCHEMA.TABLE_CONSTRAINTS cr on rc.CONSTRAINT_CATALOG = cr.CONSTRAINT_CATALOG 
      and rc.CONSTRAINT_SCHEMA = cr.CONSTRAINT_SCHEMA and rc.CONSTRAINT_NAME = cr.CONSTRAINT_NAME
      and rc.TABLE_NAME = cr.TABLE_NAME
  inner join INFORMATION_SCHEMA.TABLE_CONSTRAINTS cu on rc.UNIQUE_CONSTRAINT_CATALOG = cu.CONSTRAINT_CATALOG 
      and rc.UNIQUE_CONSTRAINT_SCHEMA = cu.CONSTRAINT_SCHEMA and rc.UNIQUE_CONSTRAINT_NAME = cu.CONSTRAINT_NAME
      and rc.REFERENCED_TABLE_NAME = cu.TABLE_NAME
) t
$FILTER
EOF

